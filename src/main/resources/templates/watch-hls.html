<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width, height=device-height, initial-scale=1,
           maximum-scale=1, minimum-scale=1, user-scalable=no"/>

    <title id="htmlTitle">播放页</title>

    <!--axios-->
    <script src="https://production-bucket.oss-cn-beijing.aliyuncs.com/dist/axios/axios-0.26.1.min.js"></script>

    <!--阿里云播放器-->
    <link rel="stylesheet" href="https://g.alicdn.com/de/prismplayer/2.13.2/skins/default/aliplayer-min.css"/>
    <script type="text/javascript" charset="utf-8"
            src="https://g.alicdn.com/de/prismplayer/2.13.2/aliplayer-min.js"></script>

    <!--mui-->
    <link href="https://production-bucket.oss-cn-beijing.aliyuncs.com/dist/mui/mui-3.7.1.min.css" rel="stylesheet">
    <script src="https://production-bucket.oss-cn-beijing.aliyuncs.com/dist/mui/mui-3.7.1.min.js"></script>
</head>

<body>

<div>
    <!--阿里云播放器-->
    <div class="prism-player" id="player-con"></div>

<!--    <div id="resolutionGroups" style="margin-top: 10px;margin-left: 40px">-->
<!--        <button id="btn1080" type="button" class="mui-btn mui-btn-primary">1080p</button>-->
<!--        <button id="btn720" style="margin-left: 35px" type="button" class="mui-btn mui-btn-success">720p</button>-->
<!--        <span id="currentResolution" style="margin-left: 20px;padding-top:10px;font-size: 25px"></span>-->
<!--    </div>-->
    <div><span id="errorInfo" style="font-size: 30px"></span></div>
    <div id="div_title" style="font-size: 30px;color: blue;margin-top: 16px;line-height:30px"></div>
    <div id="watchCount" style="font-size: 17px;color: darkcyan;margin-top: 14px"></div>
    <div id="createTime" style="font-size: 17px;color: darkcyan;margin-top: 6px"></div>
    <div id="description" style="font-size: 20px"></div>
</div>

<script>
    let videoId;
    let watchId;
    let coverUrl;

    let videoStatus;
    // let SD;
    // let HD;
    let currentUrl;
    // let playUrlList;
    let player;

    // let resolutionGroups = document.getElementById("resolutionGroups");
    // let btn1080 = document.getElementById("btn1080");
    // let btn720 = document.getElementById("btn720");
    // let currentResolution = document.getElementById("currentResolution");
    let playerElement = document.getElementById("player-con");

    //获取url路径中的参数
    function getUrlVariable(key) {
        const query = window.location.search.substring(1);
        const vars = query.split("&");
        for (let i = 0; i < vars.length; i++) {
            const pair = vars[i].split("=");
            if (pair[0] === key) {
                return pair[1];
            }
        }
        return false;
    }

    //判断是否是pc端
    function isPC() {
        let userAgent = navigator.userAgent;
        let mobileAgents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];
        for (let i = 0; i < mobileAgents.length; i++) {
            if (userAgent.indexOf(mobileAgents[i]) > 0) {
                return false;
            }
        }
        return true;
    }

    //根据url开始播放，如果换播放器，需要改这里
    function playByM3u8UrlAndTime(m3u8Url, time) {
        currentUrl = m3u8Url;

        //阿里云播放器
        player = new Aliplayer({
                "id": "player-con",
                "source": currentUrl,
                // "cover": coverUrl,
                "width": "100%",
                "height": "500px",
                "autoplay": true,
                "isLive": false,
                "rePlay": false,
                "playsinline": true,
                "isVBR": true,
                "preload": true,
                "controlBarVisibility": "hover",
                "useH5Prism": true
            }, function (player) {
                player.seek(time);
            }
        );
    }

    //加载视频
    function loadVideo() {
        watchId = getUrlVariable("v");
        //获取播放地址
        axios.get('/watchController/getWatchInfo?watchId=' + watchId
            + '&clientId=' + localStorage.clientId
            + '&sessionId=' + sessionStorage.sessionId)
            .then(function (res) {
                //开始播放
                startPlayVideo(res.data.data);

                //加载视频信息
                loadVideoInfo(videoId);
                //增加观看记录
                addWatchHistory();
                //给播放器加监听
                addPlayerListeners();
            })
    }

    //播放视频
    function startPlayVideo(data) {
        videoId = data.videoId;
        //封面
        coverUrl = data.coverUrl;
        //播放地址
        // playUrlList = data.playUrlList;

        //分辨率url
        // for (let i = 0; i < playUrlList.length; i++) {
        //     let each = playUrlList[i];
        //     if (each.resolution === '720p') {
        //         SD = each.url;
        //     } else if (each.resolution === '1080p') {
        //         HD = each.url;
        //     }
        // }

        //判断视频状态，如果已就绪，就创建播放器。如果还没就绪，就提示
        videoStatus = data.videoStatus;
        if (videoStatus !== "READY") {
            //如果视频不是 已就绪状态
            document.getElementById("errorInfo").innerHTML
                = "视频正在上传或转码<br>" + "请稍后再来<br>"
                + "videoId=" + videoId + "<br>" + "当前状态：" + data.videoStatus;
            playerElement.style.display = "none";
            return;
        }

        //视频组件宽度
        playerElement.style.width = "98%";
        //pc端自动网页全屏
        if (isPC()) {
            playerElement.style.height = (window.innerHeight - 30) + "px";
        }

        //自适应码率播放
        playByM3u8UrlAndTime(data.multivariantPlaylistUrl, 0);

        //如果只有一种分辨率，那就只播一个
        // if (playUrlList.length === 1) {
        //     if (HD != null) {
        //         currentResolution.innerText = "1080p";
        //         playByM3u8UrlAndTime(HD, 0);
        //     } else {
        //         currentResolution.innerText = "720p";
        //         playByM3u8UrlAndTime(SD, 0);
        //     }
        //     //隐藏分辨率按钮组
        //     resolutionGroups.style.display = "none";
        //     return;
        // }

        //如果有两个分辨率
        //开始播放1080p
        // currentResolution.innerText = "1080p";
        // playByM3u8UrlAndTime(HD, 0);

        //设置切换分辨率按钮监听
        // btn1080.addEventListener("click", function () {
        //     //如果当前不是HD，那就切换成HD播放
        //     if (currentUrl !== HD) {
        //         currentResolution.innerText = "1080p";
        //         playByM3u8UrlAndTime(HD, player.getCurrentTime());
        //     }
        // });
        // btn720.addEventListener("click", function () {
        //     if (currentUrl !== SD) {
        //         currentResolution.innerText = "720p";
        //         playByM3u8UrlAndTime(SD, player.getCurrentTime());
        //     }
        // });
    }

    //加载视频信息
    function loadVideoInfo(videoId) {
        //加载title等信息
        axios.get('/video/getVideoDetail?videoId=' + videoId)
            .then(function (res) {
                let data = res.data.data;
                // document.getElementById("htmlTitle").innerText = data.title;
                document.getElementById("div_title").innerText = data.title;
                document.getElementById("watchCount").innerText = "观看次数：" + data.watchCount;
                document.getElementById("description").innerText = data.description;

                //发布时间：
                //如果是用户自己上传的视频，使用create time
                //如果是youtube搬运视频，使用publish time
                // let createTime = document.getElementById("createTime");
                // if (data.type === "USER_UPLOAD") {
                //     createTime.innerText = "发布时间：" + data.createTimeString;
                // } else if (data.type === "YOUTUBE") {
                //     createTime.innerText = "发布时间：" + data.youtubePublishTimeString;
                // }
            });
    }

    //增加观看记录
    function start() {
        //先搞定clientId和sessionId，请求用户微服务
        handleClientId();
        handleSessionId();
    }

    //clientId
    function handleClientId() {
        if (localStorage.getItem("clientId") != null) {
            onHandleIdsFinished();
            return;
        }
        axios.get('//' + document.domain + ':' + location.port + '/client/requestClientId')
            .then(function (res) {
                localStorage.clientId = res.data.data.clientId;
                onHandleIdsFinished();
            });
    }

    //sessionId
    function handleSessionId() {
        if (sessionStorage.getItem("sessionId") != null) {
            onHandleIdsFinished();
            return;
        }
        axios.get('//' + document.domain + ':' + location.port + '/session/requestSessionId')
            .then(function (res) {
                sessionStorage.sessionId = res.data.data.sessionId;
                onHandleIdsFinished();
            });
    }

    //是否已经处理完成了id，避免重复提交请求
    let isIdsHandled = false;

    //在获取到两个id之后
    function onHandleIdsFinished() {
        //如果没有clientId或者sessionId，跳过
        if (isIdsHandled || localStorage.getItem("clientId") == null
            || sessionStorage.getItem("sessionId") == null) {
            return;
        }
        isIdsHandled = true;
        //id完成，开始加载视频
        loadVideo();
    }

    //增加观看记录
    function addWatchHistory() {
        axios.get('/watchController/addWatchLog?videoId=' + videoId
            + '&clientId=' + localStorage.clientId
            + '&sessionId=' + sessionStorage.sessionId
            + '&videoStatus=' + videoStatus)
            .then(function (res) {
            });
    }

    //增加监听事件
    function addPlayerListeners(){
        // player.on("playing",function (res){
        //     console.log(res);
        // });
    }

    //程序从这里开始
    start();

</script>
</body>