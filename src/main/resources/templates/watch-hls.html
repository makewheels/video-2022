<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta name="viewport"
          content="width=device-width, height=device-height, initial-scale=1,
           maximum-scale=1, minimum-scale=1, user-scalable=no"/>

    <title id="title">播放页</title>
    <script src="https://production-bucket.oss-cn-beijing.aliyuncs.com/dist/axios/axios-0.26.1.min.js"></script>

    <!--腾讯云播放器-->
    <link href="https://web.sdk.qcloud.com/player/tcplayer/release/v4.5.1/tcplayer.min.css" rel="stylesheet"/>
    <script src="https://web.sdk.qcloud.com/player/tcplayer/release/v4.5.1/libs/TXLivePlayer-1.2.0.min.js"></script>
    <script src="https://web.sdk.qcloud.com/player/tcplayer/release/v4.5.1/libs/hls.min.0.13.2m.js"></script>
    <script src="https://web.sdk.qcloud.com/player/tcplayer/release/v4.5.1/tcplayer.v4.5.1.min.js"></script>


    <link href="https://cdn.bootcdn.net/ajax/libs/mui/3.7.1/css/mui.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/mui/3.7.1/js/mui.min.js"></script>
</head>

<body>

<div>
    <video id="player-container-id" width="100%" height="300px"
           preload="auto" playsinline webkit-playsinline>
    </video>
    <div id="resolutionGroups" style="margin-top: 10px;margin-left: 40px">
        <button id="btn1080" type="button" class="mui-btn mui-btn-primary">1080p</button>
        <button id="btn720" style="margin-left: 35px" type="button" class="mui-btn mui-btn-success">720p</button>
        <span id="currentResolution" style="margin-left: 20px;padding-top:10px;font-size: 25px"></span>
    </div>
    <div><span id="errorInfo" style="font-size: 30px"></span></div>
    <div id="div_title" style="font-size: 30px;color: blue;margin-top: 16px"></div>
    <div id="watchCount" style="font-size: 17px;color: darkcyan;margin-top: 14px"></div>
    <div id="createTime" style="font-size: 17px;color: darkcyan;margin-top: 6px"></div>
    <div id="description" style="font-size: 20px"></div>
</div>

<script>
    let videoId;
    let watchId;

    let videoStatus;

    //获取url路径中的参数
    function getUrlVariable(key) {
        const query = window.location.search.substring(1);
        const vars = query.split("&");
        for (let i = 0; i < vars.length; i++) {
            const pair = vars[i].split("=");
            if (pair[0] === key) {
                return pair[1];
            }
        }
        return false;
    }

    /**
     * 判断是否是pc端
     */
    function IsPC() {
        var userAgentInfo = navigator.userAgent;
        var Agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];
        var flagPc = true;
        for (var v = 0; v < Agents.length; v++) {
            if (userAgentInfo.indexOf(Agents[v]) > 0) {
                return false;
            }
        }
        return true;
    }

    let SD;
    let HD;
    let currentUrl;
    let player;

    //根据url播放
    function playByM3u8Url(m3u8Url, time) {
        currentUrl = m3u8Url;
        if (player == null) {
            player = TCPlayer('player-container-id', {autoplay: true});
        }
        player.src(m3u8Url);
        player.play();
        player.ready(function () {
            player.currentTime(time);
        });
    }

    //加载视频
    function loadWatchInfo() {
        let resolutionGroups = document.getElementById("resolutionGroups");
        let btn1080 = document.getElementById("btn1080");
        let btn720 = document.getElementById("btn720");
        let currentResolution = document.getElementById("currentResolution");

        watchId = getUrlVariable("v");
        //获取播放地址
        axios.get('/video/getWatchInfo?watchId=' + watchId)
            .then(function (res) {
                let data = res.data.data;
                videoId = data.videoId;
                //封面
                let coverUrl = data.coverUrl;
                //播放地址
                let playUrlList = data.playUrlList;

                for (let i = 0; i < playUrlList.length; i++) {
                    let each = playUrlList[i];
                    if (each.resolution === '720p') {
                        SD = each.url;
                    } else if (each.resolution === '1080p') {
                        HD = each.url;
                    }
                }

                videoStatus = data.videoStatus;
                //判断视频状态，如果已就绪，就创建播放器。如果还没就绪，就提示
                if (data.videoStatus === "READY") {
                    //先以1080p播放
                    playByM3u8Url(HD, 0);
                    currentResolution.innerText = "1080p";

                    //如果只有一种分辨率，那就只播一个
                    if (playUrlList.length === 1) {
                        if (HD != null) {
                            playByM3u8Url(HD, 0);
                        } else {
                            playByM3u8Url(SD, 0);
                        }
                        //隐藏分辨率按钮组
                        resolutionGroups.style.display = "none";
                    } else {
                        //设置切换分辨率按钮监听
                        btn1080.addEventListener("click", function () {
                            //如果当前不是HD，那就切换成HD播放
                            if (currentUrl !== HD) {
                                currentResolution.innerText = "1080p";
                                playByM3u8Url(HD, player.currentTime());
                            }
                        });
                        btn720.addEventListener("click", function () {
                            if (currentUrl !== SD) {
                                currentResolution.innerText = "720p";
                                playByM3u8Url(SD, player.currentTime());
                            }
                        });
                    }

                    let playerVideo = document.getElementById("player-container-id");
                    playerVideo.style.width = "100%";
                    //pc端自动网页全屏
                    if (IsPC()) {
                        playerVideo.style.height = (window.innerHeight - 50) + "px";
                    }
                } else {
                    document.getElementById("errorInfo").innerHTML
                        = "视频正在上传或转码<br>"
                        + "请稍后再来<br>"
                        + "videoId=" + videoId + "<br>"
                        + "当前状态：" + data.videoStatus;
                    document.getElementById("player-container-id").style.display = "none";
                }

                afterVideoLoaded(videoId);
            })
    }

    //在视频已加载后
    function afterVideoLoaded(videoId) {
        loadVideoInfo(videoId);
        addWatchLog(videoId);
    }

    //加载视频信息
    function loadVideoInfo(videoId) {
        //加载title等信息
        axios.get('/video/getVideoDetail?videoId=' + videoId)
            .then(function (res) {
                let data = res.data.data;
                document.getElementById("title").innerText = "video-2022-" + videoId;
                document.getElementById("div_title").innerText = data.title;
                document.getElementById("watchCount").innerText = "观看次数：" + data.watchCount;
                //如果是用户自己上传的视频，使用create time
                //如果是youtube搬运视频，使用publish time
                if (data.type === "USER_UPLOAD") {
                    document.getElementById("createTime").innerText = "发布时间：" + data.createTimeString;
                } else if (data.type === "YOUTUBE") {
                    document.getElementById("createTime").innerText = "发布时间：" + data.youtubePublishTimeString;
                }
                document.getElementById("description").innerText = data.description;
            });
    }

    //增加观看次数
    function addWatchLog(videoId) {
        //先搞定clientId和sessionId，请求用户服务器
        handleClientId();
        handleSessionId();
    }

    //clientId
    function handleClientId() {
        if (localStorage.getItem("clientId") == null) {
            axios.get('//' + document.domain + ':5021/user-micro-service-2022/client/requestClientId')
                .then(function (res) {
                    let data = res.data.data;
                    localStorage.clientId = data.clientId;
                    runAddWatchLog();
                });
        } else {
            runAddWatchLog();
        }
    }

    //sessionId
    function handleSessionId() {
        if (sessionStorage.getItem("sessionId") == null) {
            axios.get('//' + document.domain + ':5021/user-micro-service-2022/session/requestSessionId')
                .then(function (res) {
                    let data = res.data.data;
                    sessionStorage.sessionId = data.sessionId;
                    runAddWatchLog();
                });
        } else {
            runAddWatchLog();
        }
    }

    let hasAddWatchLog = false;

    function runAddWatchLog() {
        //如果没有clientId或者sessionId，跳过
        if (localStorage.getItem("clientId") == null
            || sessionStorage.getItem("sessionId") == null
            || hasAddWatchLog) {
            return;
        }
        //增加观看次数，只有在ready状态，才增加
        if (videoStatus === "READY") {
            axios.get('/video/addWatchLog?videoId=' + videoId
                + '&clientId=' + localStorage.clientId
                + '&sessionId=' + sessionStorage.sessionId)
                .then(function (res) {
                    hasAddWatchLog = true;
                });
        }
    }

    //从这里开始
    loadWatchInfo();

</script>
</body>