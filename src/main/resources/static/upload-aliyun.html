<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>上传视频-阿里云</title>

    <!--    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>-->
    <script src="https://production-bucket.oss-cn-beijing.aliyuncs.com/dist/axios/axios-0.26.1.min.js"></script>
    <script src="https://code.bdstatic.com/npm/@baiducloud/sdk@1.0.0-rc.32/dist/baidubce-sdk.bundle.min.js"></script>
    <script src="https://lib.baomitu.com/async/3.2.3/async.min.js"></script>

    <!--阿里云oss-->
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.17.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>
</head>

<body>

<script>
    function jumpToLogin() {
        window.location.href = "//" + document.domain + ":5021/user-micro-service-2022/login.html" +
            "?target=" + window.location.href;
    }

    function checkToken() {
        //检查token，如果没有跳转登录页
        if (localStorage.token == null) {
            jumpToLogin();
            return;
        }
        axios.get("//" + document.domain + ":5021/user-micro-service-2022/user/getUserByToken?token=" + localStorage.token)
            .then(function (res) {
                if (res.data.code === 1001) {
                    jumpToLogin();
                }
            });
    }

    checkToken();
</script>

<input type="file" id="input_file"/>
<br>

<span>Title:</span>
<input id="input_title" type="text" maxlength="100"/>
<br>

<span>Description:</span>
<input id="input_description" type="text" maxlength="1000"/>
<br>

<button id="btn_update" type="button">修改</button>
<button id="btn_copy" type="button">一键复制</button>
<br>

<span id="shortUrl"></span>
<br>

<span id="watchUrl"></span>
<br>

<b>
    <span id="text_progress" style="color: blue;margin-left: 20px;font-size: 30px"></span>
</b>

<script>
    let input_file = document.getElementById("input_file");

    let input_title = document.getElementById("input_title");
    let input_description = document.getElementById("input_description");
    let btn_update = document.getElementById("btn_update");

    let shortUrl = document.getElementById("shortUrl");
    let watchUrl = document.getElementById("watchUrl");

    let text_progress = document.getElementById("text_progress");

    // 监听选中文件
    input_file.onchange = () => {
        const selectedFile = input_file.files[0];
        let originalFilename = selectedFile.name;
        let size = selectedFile.size;
        input_title.value = originalFilename.substring(0, originalFilename.lastIndexOf("."));
        createVideo(originalFilename, size, "USER_UPLOAD");
    }

    let fileId;
    let videoId;
    let watchId;

    //创建视频
    function createVideo(originalFilename, size, type) {
        axios.post("/video/create", {
            originalFilename: originalFilename,
            size: size,
            type: type
        }, {
            headers: {"token": localStorage.token}
        }).then(function (res) {
            let data = res.data.data;
            fileId = data.fileId;
            videoId = data.videoId;
            watchId = data.watchId;

            shortUrl.innerText = data.shortUrl;
            watchUrl.innerText = data.watchUrl;
            beginUpload();
        });
    }

    //修改视频信息按钮
    btn_update.addEventListener("click", function () {
        if (videoId === undefined) {
            return;
        }
        axios.post("/video/updateInfo", {
            id: videoId,
            title: input_title.value,
            description: input_description.value
        }, {
            headers: {"token": localStorage.token}
        }).then(function (res) {
        });
    });

    //一键复制按钮
    btn_copy.addEventListener("click", function () {
        let content = "【" + input_title.value + "】" + "\n" + shortUrl.innerText;
        navigator.clipboard.writeText(content);
    });

    function updateProgress(state) {
        let progress = state.loaded / state.total;
        progress = progress * 100;
        text_progress.innerText = (progress.toFixed(2) + " %");
    }

    let chunkSize = 1024 * 1024; // 分块大小
    let uploadId;

    let bucket;
    let key;

    let bosClient;

    //我的开始上传文件
    function beginUpload() {
        //获取上传凭证
        axios.get("/file/getUploadCredentials?fileId=" + fileId, {
            headers: {"token": localStorage.token}
        }).then(function (res) {
            runUpload(res.data.data);
        });
    }

    //拿到凭证之后，真正开始上传
    async function runUpload(uploadCredentials) {
        const file = document.getElementById('input_file').files[0];

        let key = uploadCredentials.key;
        const client = new OSS({
            bucket: uploadCredentials.bucket,
            endpoint: uploadCredentials.endpoint,
            accessKeyId: uploadCredentials.accessKeyId,
            accessKeySecret: uploadCredentials.secretKey,
            stsToken: uploadCredentials.sessionToken,
            secure: true
        });

        //分片上传
        const result = await client.multipartUpload(key, file, {
            partSize: 1024 * 1024,
            progress: function (p, checkpoint) {
                let percent = p * 100;
                text_progress.innerText = percent.toFixed(2) + " %";
            }
        });

        if (result.res.status === 200) {
            onUploadFinish();
        }
    }

    //在上传完成时
    function onUploadFinish() {
        //通知文件上传完成
        axios.get("/file/uploadFinish?fileId=" + fileId, {
            headers: {"token": localStorage.token}
        }).then(function (res) {
            //通知视频 源文件上传完成
            axios.get("/video/originalFileUploadFinish?videoId=" + videoId, {
                headers: {"token": localStorage.token}
            }).then(function (res) {
                text_progress.innerText = "上传已完成";
            });
        });
    }
</script>

</body>
</html>